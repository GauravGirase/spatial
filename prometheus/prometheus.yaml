# ==============================
# Global configuration
# ==============================
global:
  # Default scrape interval for all jobs
  # 15s is a good balance between visibility and storage usage
  scrape_interval: 15s

  # How often rules (recording/alerting) are evaluated
  # Usually same as scrape_interval
  evaluation_interval: 15s

  # Maximum time Prometheus waits for a scrape response
  # Must be lower than scrape_interval
  scrape_timeout: 10s

  # External labels are added to all metrics
  # Very important in HA / federation setups
  external_labels:
    environment: production
    region: us-east-1


# ==============================
# Rule files (alerting + recording rules)
# Keep rules separate for better organization
# ==============================
rule_files:
  - /etc/prometheus/rules/*.yml


# ==============================
# Alertmanager configuration
# Required if using alerting
# ==============================
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - "alertmanager.example.com:9093"


# ==============================
# Scrape configurations
# Defines what Prometheus monitors
# ==============================
scrape_configs:

  # --------------------------------
  # 1. Monitor Prometheus itself
  # --------------------------------
  - job_name: "prometheus"

    # Override default scrape interval for this job (optional)
    scrape_interval: 15s

    static_configs:
      - targets:
          - "localhost:9090"

    # Add custom labels to this job
    labels:
      service: prometheus


  # --------------------------------
  # 2. Node Exporter (Linux servers)
  # --------------------------------
  - job_name: "node_exporter"

    # If all nodes expose metrics at /metrics (default), no need to define metrics_path
    static_configs:
      - targets:
          - "node1.example.com:9100"
          - "node2.example.com:9100"

    # Relabel to make instance label cleaner
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: "([^:]+):.*"
        replacement: "$1"


  # --------------------------------
  # 3. Application Metrics (HTTPS secured)
  # --------------------------------
  - job_name: "my_app"

    # If application exposes metrics on custom path
    metrics_path: /actuator/prometheus

    # Use HTTPS
    scheme: https

    static_configs:
      - targets:
          - "app1.example.com:443"
          - "app2.example.com:443"

    # TLS configuration for secure scraping
    tls_config:
      # Set to false in production if certificates are valid
      insecure_skip_verify: false

    # If application requires authentication
    basic_auth:
      username: prometheus
      password_file: /etc/prometheus/secrets/app_password


  # --------------------------------
  # 4. Blackbox Exporter (Endpoint Monitoring)
  # --------------------------------
  - job_name: "blackbox_http"

    metrics_path: /probe
    params:
      module: [http_2xx]   # Must match module in blackbox.yml

    static_configs:
      - targets:
          - https://example.com
          - https://api.example.com

    # Tell Prometheus to send target URL as parameter
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target

      - source_labels: [__param_target]
        target_label: instance

      # Replace target address with blackbox exporter address
      - target_label: __address__
        replacement: blackbox-exporter.example.com:9115
